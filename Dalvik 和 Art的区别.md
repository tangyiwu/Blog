## Dalvik 和 Art

### 1. 工作原理

Dalvik是一种JIT(just-in-time)的虚拟机，每次应用启动时，把dex或odex文件加载进内存及时翻译（动态翻译），将dex或odex中的dalvik code（smali指令集）运行态翻译成native code去执行。

Art是一种AOT(ahead-of-time)的虚拟机，直接在应用安装时，用dex2oat将其完全翻译成native code，生成oat文件，使得虚拟机执行指令的速度得到提升，Android 7.0以后，部分又改回用JIT动态翻译了。

### 2. 内存管理

Dalvik虚拟机使用的是**标记-清理**回收算法，而且具体使用什么算法是在编译期决定的，无法在运行时动态更换。**标记-清理**回收算法无法对heap中空闲内存区域做碎片整理，所以Dalvik内存碎片较多。

Art在GC上不像Dalvik仅有一种回收算法，更具不同的运行状态使用不同的回收算法；当应用在前台运行时，响应性是最重要的，因此使用与Dalvik一样的**标记-清理**算法，当应用在后台运行时，响应性不是最重要的，这时候适合解决内存碎片问题，因此使用**标记-整理**算法，Art很好地解决了内存碎片问题。

Art在heap中单独分了一块空间名为**Large-Object_Space**，专门用来存放large object(大块内存对象)，同时引入了**moving collector**的技术，将不连续的物理内存进行对齐，对齐后，内存碎片就得到了很好的解决。Large-Object-Space的引入也是因为**moving collector**对大块内存的位移时间成本太高，而且提高了内存的利用率。

其他ART改进的GC机制：GC时更少的暂停时间、GC时并行处理、减少内存不足时出发GC的次数、减少后台内存占用。

Art的内存利用率提高了约10倍左右。



总的来看，Dalvik换成ART是以空间换时间，速度快了，空间占用大了。这是必然趋势，因为存储越来越便宜。

